<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Líneas Telefónicas</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --entel-color: #00A9E0;
            --primary-color: #4a6fa5;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .login-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .main-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .entel-brand {
            color: var(--entel-color);
            font-weight: bold;
        }
        
        .preview-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .history-item {
            border-left: 4px solid var(--entel-color);
            transition: transform 0.2s;
        }
        
        .history-item:hover {
            transform: translateX(5px);
        }
        
        .user-badge {
            background: var(--entel-color);
            color: white;
        }
        
        .phone-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1em;
        }
    </style>
</head>
<body class="d-flex align-items-center min-vh-100 py-4">
    <div class="container">
        <!-- Pantalla de Login -->
        <div id="loginScreen" class="row justify-content-center">
            <div class="col-md-6 col-lg-4">
                <div class="login-container p-4">
                    <div class="text-center mb-4">
                        <h2 class="entel-brand">ENTEL</h2>
                        <p class="text-muted">Sistema de Recargas</p>
                    </div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">Usuario</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">Contraseña</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-box-arrow-in-right"></i> Ingresar
                        </button>
                    </form>
                    <div id="loginMessage" class="alert alert-danger mt-3 d-none"></div>
                </div>
            </div>
        </div>

        <!-- Pantalla Principal -->
        <div id="mainScreen" class="d-none">
            <div class="main-container p-4">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="entel-brand mb-0">ENTEL - Recargas</h2>
                        <small class="text-muted">Bienvenido, <span id="currentUser" class="fw-bold"></span></small>
                    </div>
                    <button id="logoutBtn" class="btn btn-outline-danger">
                        <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                    </button>
                </div>

                <!-- Formulario de Recarga -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-telephone-plus"></i> Realizar Recarga</h5>
                    </div>
                    <div class="card-body">
                        <form id="rechargeForm">
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Número de teléfono</label>
                                <input type="tel" class="form-control" id="phoneNumber" 
                                       placeholder="Ej: 70012345" required
                                       pattern="[0-9]{8}" maxlength="8"
                                       title="Ingrese 8 dígitos sin espacios">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Vista previa del comando</label>
                                <div class="preview-box p-3" id="commandPreview">
                                    Ingrese un número para ver el comando
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success w-100">
                                <i class="bi bi-telephone-fill"></i> Llamar para Recargar
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Historial de Recargas -->
                <div class="card">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-clock-history"></i> Mis Recargas</h5>
                        <span class="badge bg-light text-dark" id="historyCount">0 recargas</span>
                    </div>
                    <div class="card-body">
                        <div id="loadingHistory" class="text-center py-3 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando historial...</p>
                        </div>
                        <div id="historyList">
                            <!-- El historial se cargará aquí -->
                        </div>
                        <div id="emptyHistory" class="text-center py-4">
                            <i class="bi bi-inbox display-4 text-muted"></i>
                            <p class="text-muted mt-2">No hay recargas registradas</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuración de Supabase - REEMPLAZAR CON TUS CREDENCIALES
        const SUPABASE_URL = 'https://zrbhhiayfaedatwlzqch.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyYmhoaWF5ZmFlZGF0d2x6cWNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMTcwMjgsImV4cCI6MjA3NjY5MzAyOH0.b97mGNErXGRuIorOPTf6m1awGlIyrXaAI4VS65aR-5o';

        // Usuarios predefinidos
        const USUARIOS = [
            { id: 1, username: 'e1', password: 'entel123', nombre: 'Usuario E1' },
            { id: 2, username: 'e2', password: 'entel456', nombre: 'Usuario E2' },
            { id: 3, username: 'e3', password: 'entel789', nombre: 'Usuario E3' },
            { id: 4, username: 'e4', password: 'entel012', nombre: 'Usuario E4' },
            { id: 5, username: 'e5', password: 'entel345', nombre: 'Usuario E5' },
            { id: 6, username: 'e6', password: 'entel678', nombre: 'Usuario E6' },
            { id: 7, username: 'e7', password: 'entel901', nombre: 'Usuario E7' },
            { id: 8, username: 'e8', password: 'entel234', nombre: 'Usuario E8' },
            { id: 9, username: 'e9', password: 'entel567', nombre: 'Usuario E9' },
            { id: 10, username: 'e10', password: 'entel890', nombre: 'Usuario E10' }
        ];

        // Estado de la aplicación
        let currentUser = null;

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Verificar si ya hay una sesión activa
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainScreen();
            }

            // Configurar event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('phoneNumber').addEventListener('input', updateCommandPreview);
            document.getElementById('rechargeForm').addEventListener('submit', handleRecharge);
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            // Verificar credenciales
            const user = USUARIOS.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainScreen();
                messageDiv.classList.add('d-none');
            } else {
                messageDiv.textContent = 'Usuario o contraseña incorrectos';
                messageDiv.classList.remove('d-none');
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('mainScreen').classList.add('d-none');
            document.getElementById('loginForm').reset();
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('d-none');
            document.getElementById('mainScreen').classList.remove('d-none');
            document.getElementById('currentUser').textContent = currentUser.nombre;
            updateCommandPreview();
            loadRechargeHistory();
        }

        function updateCommandPreview() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            const preview = document.getElementById('commandPreview');
            
            if (phoneNumber && phoneNumber.length === 8) {
                preview.textContent = `*222*2*${phoneNumber}*20*1#`;
                preview.classList.add('fw-bold');
            } else {
                preview.textContent = 'Ingrese un número válido de 8 dígitos';
                preview.classList.remove('fw-bold');
            }
        }

        async function handleRecharge(e) {
            e.preventDefault();
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!phoneNumber || phoneNumber.length !== 8) {
                alert('Por favor, ingrese un número de teléfono válido de 8 dígitos');
                return;
            }

            try {
                // Guardar en la base de datos
                await saveRechargeToDatabase(phoneNumber);
                
                // Limpiar el formulario
                document.getElementById('phoneNumber').value = '';
                updateCommandPreview();
                
                // Realizar la llamada
                const command = `*222*2*${phoneNumber}*20*1#`;
                const encodedCommand = encodeURIComponent(command);
                window.location.href = `tel:${encodedCommand}`;
                
            } catch (error) {
                console.error('Error al guardar la recarga:', error);
                alert('Error al procesar la recarga. Intente nuevamente.');
            }
        }

        async function saveRechargeToDatabase(phoneNumber) {
            const rechargeData = {
                user_id: currentUser.id,
                user_name: currentUser.nombre,
                phone_number: phoneNumber,
                command: `*222*2*${phoneNumber}*20*1#`,
                timestamp: new Date().toISOString()
            };

            // Llamada real a Supabase
            const response = await fetch(`${SUPABASE_URL}/rest/v1/recharge_history`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(rechargeData)
            });

            if (!response.ok) {
                throw new Error('Error al guardar en la base de datos');
            }

            // Recargar el historial después de guardar
            loadRechargeHistory();
            
            return { success: true };
        }

        async function loadRechargeHistory() {
            const loadingDiv = document.getElementById('loadingHistory');
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            
            loadingDiv.classList.remove('d-none');
            historyList.innerHTML = '';

            try {
                // Llamada real a Supabase - filtrar por usuario actual
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/recharge_history?user_id=eq.${currentUser.id}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Error al cargar el historial');
                }

                const rechargeHistory = await response.json();
                displayHistory(rechargeHistory);
                
            } catch (error) {
                console.error('Error al cargar el historial:', error);
                displayHistory([]);
            } finally {
                loadingDiv.classList.add('d-none');
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            const historyCount = document.getElementById('historyCount');
            
            // Actualizar contador
            historyCount.textContent = `${history.length} recarga${history.length !== 1 ? 's' : ''}`;
            
            if (history.length === 0) {
                emptyHistory.classList.remove('d-none');
                historyList.innerHTML = '';
                return;
            }

            emptyHistory.classList.add('d-none');
            
            historyList.innerHTML = history.map(item => `
                <div class="history-item p-3 mb-2 bg-light rounded">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="phone-display text-primary mb-1">${item.phone_number}</div>
                            <small class="text-muted">
                                <i class="bi bi-person-circle"></i> ${item.user_name}
                                • <i class="bi bi-calendar"></i> ${formatDateTime(item.timestamp)}
                            </small>
                            <div class="mt-1">
                                <small class="text-muted font-monospace">${item.command}</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i> Completada
                            </span>
                            <div class="mt-1">
                                <small class="text-muted">${formatTimeAgo(item.timestamp)}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatDateTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatTimeAgo(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Ahora mismo';
            if (diffMins < 60) return `Hace ${diffMins} min`;
            if (diffHours < 24) return `Hace ${diffHours} h`;
            if (diffDays === 1) return 'Ayer';
            return `Hace ${diffDays} días`;
        }
    </script>
</body>
</html>
