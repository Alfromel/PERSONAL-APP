<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Líneas Telefónicas</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- jsPDF para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --entel-color: #00A9E0;
            --primary-color: #4a6fa5;
        }
        
        body {
            background-color: #f5f5f5;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            margin: 0;
        }
        
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .login-container {
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
        }
        
        .entel-brand {
            color: var(--entel-color);
            font-weight: bold;
        }
        
        .history-item {
            border-left: 4px solid var(--entel-color);
            transition: transform 0.2s;
        }
        
        .history-item:hover {
            transform: translateX(5px);
        }
        
        .user-badge {
            background: var(--entel-color);
            color: white;
        }
        
        .phone-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        /* Estilos para app nativa */
        .app-header {
            background: linear-gradient(135deg, var(--entel-color) 0%, #0080b3 100%);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .app-content {
            padding: 20px;
            padding-bottom: 80px; /* Para evitar que el contenido quede detrás del botón flotante */
        }
        
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border: none;
            overflow: hidden;
        }
        
        .app-card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
            font-weight: 600;
        }
        
        .app-card-body {
            padding: 20px;
        }
        
        .app-btn {
            border-radius: 50px;
            padding: 12px 25px;
            font-weight: 600;
            border: none;
            transition: all 0.3s;
        }
        
        .app-btn-primary {
            background: var(--entel-color);
        }
        
        .app-btn-primary:hover {
            background: #0080b3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .app-form-control {
            border-radius: 10px;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .app-form-control:focus {
            border-color: var(--entel-color);
            box-shadow: 0 0 0 2px rgba(0,169,224,0.2);
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--entel-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,169,224,0.4);
            z-index: 100;
            border: none;
            transition: all 0.3s;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,169,224,0.6);
        }
        
        .history-badge {
            background: var(--entel-color);
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .clear-history-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .clear-history-btn:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        
        .modal-header {
            background-color: var(--entel-color);
            color: white;
            border-bottom: none;
        }
        
        .modal-footer {
            border-top: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Pantalla de Login -->
        <div id="loginScreen" class="login-container">
            <div class="text-center mb-5">
                <h1 class="entel-brand mb-2">ENTEL</h1>
                <p class="text-muted">Sistema de Recargas</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Usuario</label>
                    <input type="text" class="form-control app-form-control" id="username" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control app-form-control" id="password" required>
                </div>
                <button type="submit" class="btn app-btn app-btn-primary w-100 text-white">
                    <i class="bi bi-box-arrow-in-right me-2"></i> Ingresar
                </button>
            </form>
            <div id="loginMessage" class="alert alert-danger mt-3 d-none"></div>
        </div>

        <!-- Pantalla Principal -->
        <div id="mainScreen" class="d-none">
            <!-- Header de la app -->
            <div class="app-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">ENTEL Recargas</h4>
                        <small>Bienvenido, <span id="currentUser" class="fw-bold"></span></small>
                    </div>
                    <div class="user-avatar">
                        <span id="userInitial">U</span>
                    </div>
                </div>
            </div>

            <!-- Contenido principal -->
            <div class="app-content">
                <!-- Formulario de Recarga -->
                <div class="app-card">
                    <div class="app-card-header d-flex align-items-center">
                        <i class="bi bi-telephone-plus me-2"></i>
                        <span>Realizar Recarga</span>
                    </div>
                    <div class="app-card-body">
                        <form id="rechargeForm">
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Número de teléfono</label>
                                <input type="tel" class="form-control app-form-control" id="phoneNumber" 
                                       placeholder="Ej: 70012345" required
                                       pattern="[0-9]{8}" maxlength="8"
                                       title="Ingrese 8 dígitos sin espacios">
                            </div>
                            <button type="submit" class="btn app-btn app-btn-primary w-100 text-white">
                                <i class="bi bi-telephone-fill me-2"></i> Llamar para Recargar
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Historial de Recargas -->
                <div class="app-card">
                    <div class="app-card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-clock-history me-2"></i>
                            <span>Mis Recargas</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="history-badge me-2" id="historyCount">0</span>
                            <button id="clearHistoryBtn" class="clear-history-btn" title="Borrar historial">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="app-card-body p-0">
                        <div id="loadingHistory" class="text-center py-4 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando historial...</p>
                        </div>
                        <div id="historyList">
                            <!-- El historial se cargará aquí -->
                        </div>
                        <div id="emptyHistory" class="empty-state">
                            <i class="bi bi-inbox"></i>
                            <p class="mt-2">No hay recargas registradas</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón flotante para cerrar sesión -->
            <button id="logoutBtn" class="floating-action-btn" title="Cerrar sesión">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Modal para confirmar borrado de historial -->
    <div class="modal fade" id="clearHistoryModal" tabindex="-1" aria-labelledby="clearHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearHistoryModalLabel">Borrar Historial</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea borrar todo su historial de recargas?</p>
                    <p class="text-danger"><strong>Advertencia:</strong> Esta acción no se puede deshacer.</p>
                    <div class="mb-3">
                        <label for="clearPassword" class="form-label">Contraseña de confirmación:</label>
                        <input type="password" class="form-control" id="clearPassword" placeholder="Ingrese la contraseña">
                    </div>
                    <div id="clearHistoryMessage" class="alert alert-danger mt-2 d-none"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmClearHistory">Borrar Historial</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuración de Supabase - REEMPLAZAR CON TUS CREDENCIALES
        const SUPABASE_URL = 'https://zrbhhiayfaedatwlzqch.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpyYmhoaWF5ZmFlZGF0d2x6cWNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjExMTcwMjgsImV4cCI6MjA3NjY5MzAyOH0.b97mGNErXGRuIorOPTf6m1awGlIyrXaAI4VS65aR-5o';

        // Usuarios predefinidos
        const USUARIOS = [
            { id: 1, username: 'e1', password: 'entel123', nombre: 'Usuario E1' },
            { id: 2, username: 'e2', password: 'entel456', nombre: 'Usuario E2' },
            { id: 3, username: 'e3', password: 'entel789', nombre: 'Usuario E3' },
            { id: 4, username: 'e4', password: 'entel012', nombre: 'Usuario E4' },
            { id: 5, username: 'e5', password: 'entel345', nombre: 'Usuario E5' },
            { id: 6, username: 'e6', password: 'entel678', nombre: 'Usuario E6' },
            { id: 7, username: 'e7', password: 'entel901', nombre: 'Usuario E7' },
            { id: 8, username: 'e8', password: 'entel234', nombre: 'Usuario E8' },
            { id: 9, username: 'e9', password: 'entel567', nombre: 'Usuario E9' },
            { id: 10, username: 'e10', password: 'entel890', nombre: 'Usuario E10' }
        ];

        // Estado de la aplicación
        let currentUser = null;
        let currentUserHistory = [];

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Verificar si ya hay una sesión activa
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainScreen();
            }

            // Configurar event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('rechargeForm').addEventListener('submit', handleRecharge);
            document.getElementById('clearHistoryBtn').addEventListener('click', showClearHistoryModal);
            document.getElementById('confirmClearHistory').addEventListener('click', confirmClearHistory);
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            // Verificar credenciales
            const user = USUARIOS.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainScreen();
                messageDiv.classList.add('d-none');
            } else {
                messageDiv.textContent = 'Usuario o contraseña incorrectos';
                messageDiv.classList.remove('d-none');
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('mainScreen').classList.add('d-none');
            document.getElementById('loginForm').reset();
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('d-none');
            document.getElementById('mainScreen').classList.remove('d-none');
            document.getElementById('currentUser').textContent = currentUser.nombre;
            document.getElementById('userInitial').textContent = currentUser.nombre.charAt(0);
            loadRechargeHistory();
        }

        async function handleRecharge(e) {
            e.preventDefault();
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!phoneNumber || phoneNumber.length !== 8) {
                alert('Por favor, ingrese un número de teléfono válido de 8 dígitos');
                return;
            }

            try {
                // Guardar en la base de datos
                await saveRechargeToDatabase(phoneNumber);
                
                // Limpiar el formulario
                document.getElementById('phoneNumber').value = '';
                
                // Realizar la llamada
                const command = `*222*2*${phoneNumber}*20*1#`;
                const encodedCommand = encodeURIComponent(command);
                window.location.href = `tel:${encodedCommand}`;
                
            } catch (error) {
                console.error('Error al guardar la recarga:', error);
                alert('Error al procesar la recarga. Intente nuevamente.');
            }
        }

        async function saveRechargeToDatabase(phoneNumber) {
            // Obtener fecha y hora actual del dispositivo del usuario
            const now = new Date();
            const timestamp = now.toLocaleString('es-ES');
            const created_at = now.toLocaleString('es-ES');

            const rechargeData = {
                user_id: currentUser.id,
                user_name: currentUser.nombre,
                phone_number: phoneNumber,
                command: `*222*2*${phoneNumber}*20*1#`,
                timestamp: timestamp,
                created_at: created_at
            };

            // Llamada real a Supabase
            const response = await fetch(`${SUPABASE_URL}/rest/v1/recharge_history`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(rechargeData)
            });

            if (!response.ok) {
                throw new Error('Error al guardar en la base de datos');
            }

            // Recargar el historial después de guardar
            loadRechargeHistory();
            
            return { success: true };
        }

        async function loadRechargeHistory() {
            const loadingDiv = document.getElementById('loadingHistory');
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            
            loadingDiv.classList.remove('d-none');
            historyList.innerHTML = '';

            try {
                // Llamada real a Supabase - filtrar por usuario actual
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/recharge_history?user_id=eq.${currentUser.id}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Error al cargar el historial');
                }

                const rechargeHistory = await response.json();
                currentUserHistory = rechargeHistory; // Guardar historial completo
                displayHistory(rechargeHistory);
                
            } catch (error) {
                console.error('Error al cargar el historial:', error);
                displayHistory([]);
            } finally {
                loadingDiv.classList.add('d-none');
            }
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            const historyCount = document.getElementById('historyCount');
            
            // Actualizar contador
            historyCount.textContent = history.length;
            
            if (history.length === 0) {
                emptyHistory.classList.remove('d-none');
                historyList.innerHTML = '';
                return;
            }

            emptyHistory.classList.add('d-none');
            
            historyList.innerHTML = history.map((item, index) => `
                <div class="history-item p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <span class="badge bg-secondary me-2">${history.length - index}</span>
                                <div class="phone-display text-primary">${item.phone_number}</div>
                            </div>
                            <small class="text-muted">
                                <i class="bi bi-person-circle"></i> ${item.user_name}
                                • <i class="bi bi-calendar"></i> ${item.timestamp}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">
                                <i class="bi bi-check-circle"></i>
                            </span>
                            <div class="mt-1">
                                <small class="text-muted">${formatTimeAgo(item.timestamp)}</small>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatTimeAgo(dateString) {
            // Convertir el string de fecha del dispositivo del usuario a objeto Date
            const dateParts = dateString.split(/[/,: ]/);
            const day = parseInt(dateParts[0]);
            const month = parseInt(dateParts[1]) - 1; // Los meses en JavaScript van de 0 a 11
            const year = parseInt(dateParts[2]);
            const hour = parseInt(dateParts[3]);
            const minute = parseInt(dateParts[4]);
            const second = parseInt(dateParts[5] || 0);
            
            const date = new Date(year, month, day, hour, minute, second);
            const now = new Date(); // Hora actual del dispositivo del usuario
            
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Ahora mismo';
            if (diffMins < 60) return `Hace ${diffMins} min`;
            if (diffHours < 24) return `Hace ${diffHours} h`;
            if (diffDays === 1) return 'Ayer';
            return `Echo`;
        }

        function showClearHistoryModal() {
            // Verificar si hay historial para borrar
            if (currentUserHistory.length === 0) {
                alert('No hay historial para borrar');
                return;
            }
            
            // Resetear el modal
            document.getElementById('clearPassword').value = '';
            document.getElementById('clearHistoryMessage').classList.add('d-none');
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('clearHistoryModal'));
            modal.show();
        }

        async function confirmClearHistory() {
            const password = document.getElementById('clearPassword').value;
            const messageDiv = document.getElementById('clearHistoryMessage');
            
            // Verificar contraseña
            if (password !== 'ivan5986') {
                messageDiv.textContent = 'Contraseña incorrecta';
                messageDiv.classList.remove('d-none');
                return;
            }
            
            try {
                // Generar PDF antes de borrar
                await generateHistoryPDF();
                
                // Borrar el historial de la base de datos
                await deleteUserHistory();
                
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('clearHistoryModal'));
                modal.hide();
                
                // Recargar el historial (que ahora estará vacío)
                loadRechargeHistory();
                
                alert('Historial borrado exitosamente');
                
            } catch (error) {
                console.error('Error al borrar el historial:', error);
                messageDiv.textContent = 'Error al borrar el historial';
                messageDiv.classList.remove('d-none');
            }
        }

        async function deleteUserHistory() {
            // Borrar todas las recargas del usuario actual
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/recharge_history?user_id=eq.${currentUser.id}`,
                {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=minimal'
                    }
                }
            );

            if (!response.ok) {
                throw new Error('Error al borrar el historial');
            }

            return { success: true };
        }

        function generateHistoryPDF() {
            return new Promise((resolve, reject) => {
                try {
                    // Usar jsPDF desde la variable global
                    const { jsPDF } = window.jspdf;
                    
                    // Crear nuevo documento PDF
                    const doc = new jsPDF();
                    
                    // Título
                    doc.setFontSize(20);
                    doc.setTextColor(0, 169, 224); // Color Entel
                    doc.text('Historial de Recargas - ENTEL', 20, 20);
                    
                    // Información del usuario
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Usuario: ${currentUser.nombre}`, 20, 35);
                    doc.text(`Fecha de generación: ${new Date().toLocaleString('es-ES')}`, 20, 42);
                    
                    // Tabla de recargas
                    const tableColumn = ["#", "Teléfono", "Fecha", "Comando"];
                    const tableRows = [];
                    
                    currentUserHistory.forEach((item, index) => {
                        const rowData = [
                            index + 1,
                            item.phone_number,
                            item.timestamp,
                            item.command
                        ];
                        tableRows.push(rowData);
                    });
                    
                    // Agregar tabla al PDF
                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 50,
                        theme: 'grid',
                        styles: {
                            fontSize: 10,
                            cellPadding: 3
                        },
                        headStyles: {
                            fillColor: [0, 169, 224], // Color Entel
                            textColor: 255
                        },
                        alternateRowStyles: {
                            fillColor: [240, 240, 240]
                        }
                    });
                    
                    // Guardar el PDF
                    const fileName = `Historial_Recargas_${currentUser.nombre}_${new Date().toISOString().slice(0,10)}.pdf`;
                    doc.save(fileName);
                    
                    resolve();
                } catch (error) {
                    console.error('Error al generar PDF:', error);
                    reject(error);
                }
            });
        }
    </script>
</body>
</html>

