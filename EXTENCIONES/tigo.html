<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recargas TIGO</title>
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- jsPDF para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --tigo-color: #005EB8;
            --tigo-secondary: #0077CC;
            --tigo-dark: #004C93;
            --tigo-light: #E6F2FF;
            --primary-color: #4a6fa5;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --gray-color: #6c757d;
            --light-gray: #8b96a0;
            --error-color: #dc3545;
            --echo-color: #17a2b8;
            --novalido-color: #6c757d;
        }
        
        body {
            background-color: #f5f5f5;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 0;
            margin: 0;
        }
        
        .app-container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .login-container {
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
        }
        
        .tigo-brand {
            color: var(--tigo-color);
            font-weight: bold;
            font-size: 2.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* ESTADOS MEJORADOS - SISTEMA COMPLETO */
        .history-item-echo {
            border-left: 4px solid var(--echo-color);
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.03) 0%, rgba(23, 162, 184, 0.08) 100%);
            transition: all 0.3s;
            position: relative;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 0 12px 12px 0;
            border: 1px solid rgba(23, 162, 184, 0.1);
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.05);
        }
        
        .history-item-error {
            border-left: 4px solid var(--error-color);
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.03) 0%, rgba(220, 53, 69, 0.08) 100%);
            transition: all 0.3s;
            position: relative;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 0 12px 12px 0;
            border: 1px solid rgba(220, 53, 69, 0.1);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.05);
        }
        
        .history-item-novalido {
            border-left: 4px solid var(--novalido-color);
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.03) 0%, rgba(108, 117, 125, 0.08) 100%);
            transition: all 0.3s;
            position: relative;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 0 12px 12px 0;
            border: 1px solid rgba(108, 117, 125, 0.1);
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.05);
        }
        
        .history-item-echo:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.15);
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.05) 0%, rgba(23, 162, 184, 0.12) 100%);
        }
        
        .history-item-error:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.15);
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, rgba(220, 53, 69, 0.12) 100%);
        }
        
        .history-item-novalido:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.15);
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.05) 0%, rgba(108, 117, 125, 0.12) 100%);
        }
        
        .user-badge {
            background: var(--tigo-color);
            color: white;
        }
        
        .phone-display {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            font-size: 1.3em;
            letter-spacing: 1px;
        }
        
        /* Estilos para app nativa */
        .app-header {
            background: linear-gradient(135deg, var(--tigo-color) 0%, var(--tigo-dark) 100%);
            color: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
        }
        
        .app-content {
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .app-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: none;
            overflow: hidden;
            transition: transform 0.3s;
        }
        
        .app-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        .app-card-header {
            background: linear-gradient(135deg, var(--tigo-light) 0%, #f0f9ff 100%);
            border-bottom: 1px solid #e9ecef;
            padding: 15px 20px;
            font-weight: 600;
            color: var(--tigo-dark);
        }
        
        .app-card-body {
            padding: 20px;
        }
        
        .app-btn {
            border-radius: 50px;
            padding: 12px 25px;
            font-weight: 600;
            border: none;
            transition: all 0.3s;
        }
        
        .app-btn-primary {
            background: linear-gradient(135deg, var(--tigo-color) 0%, var(--tigo-secondary) 100%);
            color: rgb(32, 31, 31);
        }
        
        .app-btn-primary:hover {
            background: linear-gradient(135deg, var(--tigo-dark) 0%, var(--tigo-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,94,184,0.4);
        }
        
        .app-form-control {
            border-radius: 10px;
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }
        
        .app-form-control:focus {
            border-color: var(--tigo-color);
            box-shadow: 0 0 0 3px rgba(0,94,184,0.2);
        }
        
        .floating-action-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--tigo-color) 0%, var(--tigo-secondary) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 6px 20px rgba(0,94,184,0.5);
            z-index: 100;
            border: none;
            transition: all 0.3s;
        }
        
        .floating-action-btn:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 8px 25px rgba(0,94,184,0.7);
        }
        
        /* BADGES DE ESTADO MEJORADOS */
        .history-badge {
            background: linear-gradient(135deg, var(--tigo-color) 0%, var(--tigo-secondary) 100%);
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .echo-badge {
            background: linear-gradient(135deg, var(--echo-color) 0%, #138496 100%);
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 5px;
            box-shadow: 0 2px 5px rgba(23, 162, 184, 0.3);
        }
        
        .error-badge {
            background: linear-gradient(135deg, var(--error-color) 0%, #c82333 100%);
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 5px;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
        }
        
        .novalido-badge {
            background: linear-gradient(135deg, var(--novalido-color) 0%, #545b62 100%);
            color: white;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 5px;
            box-shadow: 0 2px 5px rgba(108, 117, 125, 0.3);
        }
        
        /* BURBUJA AZUL PARA RECARGAS VÁLIDAS (ECHO + ERROR) */
        .recargas-validas-bubble {
            background: linear-gradient(135deg, var(--tigo-color) 0%, var(--tigo-secondary) 100%);
            color: white;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            box-shadow: 0 4px 15px rgba(0, 94, 184, 0.4);
            margin-left: 10px;
            position: relative;
            transition: all 0.3s;
        }
        
        .recargas-validas-bubble:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 94, 184, 0.6);
        }
        
        .recargas-validas-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: white;
            color: var(--tigo-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 2px solid var(--tigo-color);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
            color: var(--tigo-color);
        }
        
        .clear-history-btn {
            background: linear-gradient(135deg, var(--danger-color) 0%, #e74c3c 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 8px 15px;
            font-size: 0.9rem;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .clear-history-btn:hover {
            background: linear-gradient(135deg, #c82333 0%, var(--danger-color) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(220,53,69,0.3);
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--tigo-color) 0%, var(--tigo-dark) 100%);
            color: white;
            border-bottom: none;
            border-radius: 12px 12px 0 0;
        }
        
        .modal-footer {
            border-top: none;
        }
        
        /* SELECTOR DE ESTADO MEJORADO */
        .status-select {
            border-radius: 20px;
            padding: 6px 15px;
            font-size: 0.8rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            min-width: 90px;
            text-align: center;
        }
        
        .status-echo {
            background: linear-gradient(135deg, var(--echo-color) 0%, #138496 100%);
            color: white;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }
        
        .status-error {
            background: linear-gradient(135deg, var(--error-color) 0%, #c82333 100%);
            color: white;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .status-novalido {
            background: linear-gradient(135deg, var(--novalido-color) 0%, #545b62 100%);
            color: white;
            border: 1px solid rgba(108, 117, 125, 0.2);
        }
        
        .status-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
        }
        
        .status-select:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* INDICADORES DE ESTADO MEJORADOS */
        .echo-indicator {
            color: #138496;
            font-weight: bold;
            font-size: 0.75rem;
            background: #e7f6f8;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
            border: 1px solid rgba(23, 162, 184, 0.2);
        }
        
        .error-indicator {
            color: #c82333;
            font-weight: bold;
            font-size: 0.75rem;
            background: #fce8ea;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }
        
        .novalido-indicator {
            color: #545b62;
            font-weight: bold;
            font-size: 0.75rem;
            background: #f8f9fa;
            padding: 3px 8px;
            border-radius: 12px;
            margin-left: 8px;
            border: 1px solid rgba(108, 117, 125, 0.2);
        }
        
        .numero-badge {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gray-color) 0%, var(--light-gray) 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        /* BURBUJA DE ESTADO MEJORADA */
        .status-bubble {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            margin-left: 8px;
            flex-shrink: 0;
            position: relative;
            transition: all 0.3s;
        }
        
        .status-bubble:hover {
            transform: scale(1.1);
        }
        
        .status-bubble-echo {
            background: linear-gradient(135deg, var(--echo-color) 0%, #138496 100%);
            color: white;
        }
        
        .status-bubble-error {
            background: linear-gradient(135deg, var(--error-color) 0%, #c82333 100%);
            color: white;
        }
        
        .status-bubble-novalido {
            background: linear-gradient(135deg, var(--novalido-color) 0%, #545b62 100%);
            color: white;
        }
        
        /* Badge de estado dentro de la burbuja */
        .status-bubble-badge {
            position: absolute;
            bottom: -3px;
            right: -3px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .status-bubble-badge-echo {
            color: #138496;
        }
        
        .status-bubble-badge-error {
            color: #c82333;
        }
        
        .status-bubble-badge-novalido {
            color: #545b62;
        }
        
        .phone-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .user-info {
            font-size: 0.8rem;
            color: var(--gray-color);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .date-filter-info {
            background-color: var(--tigo-light);
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
            text-align: center;
            color: var(--tigo-dark);
            font-weight: 500;
        }
        
        /* Estado específico para números de teléfono */
        .phone-echo {
            color: #138496;
        }
        
        .phone-error {
            color: #c82333;
        }
        
        .phone-novalido {
            color: #545b62;
        }
        
        .history-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .history-action-btn {
            flex: 1;
            background: var(--tigo-light);
            border: 1px solid rgba(0, 94, 184, 0.2);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            color: var(--tigo-dark);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .history-action-btn:hover {
            background: var(--tigo-color);
            color: white;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Pantalla de Login -->
        <div id="loginScreen" class="login-container">
            <div class="text-center mb-5">
                <h1 class="tigo-brand mb-2">TIGO</h1>
                <p class="text-muted">Sistema de Recargas</p>
            </div>
            <form id="loginForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Usuario</label>
                    <input type="text" class="form-control app-form-control" id="username" required>
                </div>
                <div class="mb-4">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" class="form-control app-form-control" id="password" required>
                </div>
                <button type="submit" class="btn app-btn app-btn-primary w-100 text-white">
                    <i class="bi bi-box-arrow-in-right me-2"></i> Ingresar
                </button>
            </form>
            <div id="loginMessage" class="alert alert-danger mt-3 d-none"></div>
        </div>

        <!-- Pantalla Principal -->
        <div id="mainScreen" class="d-none">
            <!-- Header de la app -->
            <div class="app-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="mb-0">TIGO Recargas</h4>
                        <small>Bienvenido, <span id="currentUser" class="fw-bold"></span></small>
                    </div>
                    <div class="user-avatar">
                        <span id="userInitial">U</span>
                    </div>
                </div>
            </div>

            <!-- Contenido principal -->
            <div class="app-content">
                <!-- Formulario de Recarga -->
                <div class="app-card">
                    <div class="app-card-header d-flex align-items-center">
                        <i class="bi bi-telephone-plus me-2"></i>
                        <span>Realizar Recarga</span>
                    </div>
                    <div class="app-card-body">
                        <form id="rechargeForm">
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">Número de teléfono</label>
                                <input type="tel" class="form-control app-form-control" id="phoneNumber" 
                                       placeholder="Ej: 70012345" required
                                       pattern="[0-9]{8}" maxlength="8"
                                       title="Ingrese 8 dígitos sin espacios">
                            </div>
                            <div class="mb-3">
                                <label for="status" class="form-label">Estado</label>
                                <select class="form-select app-form-control" id="status" required>
                                    <option value="ECHO">Echo</option>
                                    <option value="ERROR">Error</option>
                                    <option value="NO VALIDO">No Valido</option>
                                </select>
                            </div>
                            <button type="submit" class="btn app-btn app-btn-primary w-100">
                                <i class="bi bi-telephone-fill me-2"></i> Llamar para Recargar
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Historial de Recargas -->
                <div class="app-card">
                    <div class="app-card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-clock-history me-2"></i>
                            <span>Mis Recargas</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <!-- BURBUJA AZUL CON RECARGAS VÁLIDAS (ECHO + ERROR) -->
                            <div class="recargas-validas-bubble" title="Recargas Válidas (Echo + Error)">
                                <i class="bi bi-phone"></i>
                                <div class="recargas-validas-count" id="recargasValidasCount">0</div>
                            </div>
                            
                            <span class="echo-badge" id="echoCount">0</span>
                            <span class="error-badge" id="errorCount">0</span>
                            <span class="novalido-badge" id="novalidoCount">0</span>
                            <button id="clearHistoryBtn" class="clear-history-btn ms-2" title="Descargar PDF y eliminar historial">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="app-card-body p-0">
                        <div id="loadingHistory" class="text-center py-4 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2 text-muted">Cargando historial...</p>
                        </div>
                        
                        <!-- Información del filtro automático -->
                        <div id="dateFilterInfo" class="date-filter-info d-none">
                            <i class="bi bi-calendar-check me-2"></i>
                            <span>Día: <span id="currentDateDisplay"></span></span>
                        </div>
                        
                        <!-- Lista del historial -->
                        <div class="history-container" id="historyContainer">
                            <div id="historyList">
                                <!-- El historial se cargará aquí -->
                            </div>
                            <div id="emptyHistory" class="empty-state">
                                <i class="bi bi-inbox"></i>
                                <p class="mt-2">No hay recargas registradas</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Botón flotante para cerrar sesión -->
            <button id="logoutBtn" class="floating-action-btn" title="Cerrar sesión">
                <i class="bi bi-box-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Modal para confirmar descarga y eliminar historial -->
    <div class="modal fade" id="clearHistoryModal" tabindex="-1" aria-labelledby="clearHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="clearHistoryModalLabel">Descargar PDF y Eliminar Historial</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de que desea descargar el historial en PDF y eliminar permanentemente todos los registros del historial?</p>
                    <p class="text-danger"><strong>¡Advertencia!</strong> Esta acción eliminará permanentemente todo el historial de recargas de la base de datos y no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmClearHistory">Descargar y Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuración de Supabase
        const SUPABASE_URL = 'https://iyowgljzuryeowyceaio.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_xr2MZ4YwV7zslfp9Wzs2WQ_aSfFX_87';

        // Estado de la aplicación
        let currentUser = null;
        let currentUserHistory = [];
        let currentDateFilter = null;

        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Verificar si ya hay una sesión activa
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainScreen();
            }

            // Configurar event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            document.getElementById('rechargeForm').addEventListener('submit', handleRecharge);
            document.getElementById('clearHistoryBtn').addEventListener('click', showClearHistoryModal);
            document.getElementById('confirmClearHistory').addEventListener('click', confirmClearHistory);
        }

        // Función para cargar usuarios desde la base de datos
        async function loadUsersFromDatabase() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/users`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Error al cargar usuarios desde la base de datos');
                }

                const usuarios = await response.json();
                return usuarios;
                
            } catch (error) {
                console.error('Error al cargar usuarios:', error);
                throw new Error('No se pudo conectar con la base de datos. Intente nuevamente.');
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageDiv = document.getElementById('loginMessage');

            // Mostrar mensaje de carga
            messageDiv.textContent = 'Cargando usuarios...';
            messageDiv.className = 'alert alert-info mt-3';
            messageDiv.classList.remove('d-none');

            try {
                // Cargar usuarios desde la base de datos
                const usuarios = await loadUsersFromDatabase();

                // Verificar credenciales
                const user = usuarios.find(u => u.username === username && u.password === password);
                
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showMainScreen();
                    messageDiv.classList.add('d-none');
                } else {
                    messageDiv.textContent = 'Usuario o contraseña incorrectos';
                    messageDiv.className = 'alert alert-danger mt-3';
                }
            } catch (error) {
                console.error('Error en el login:', error);
                messageDiv.textContent = error.message;
                messageDiv.className = 'alert alert-danger mt-3';
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('d-none');
            document.getElementById('mainScreen').classList.add('d-none');
            document.getElementById('loginForm').reset();
        }

        function showMainScreen() {
            document.getElementById('loginScreen').classList.add('d-none');
            document.getElementById('mainScreen').classList.remove('d-none');
            document.getElementById('currentUser').textContent = currentUser.nombre;
            document.getElementById('userInitial').textContent = currentUser.nombre.charAt(0);
            loadRechargeHistory();
        }

        async function handleRecharge(e) {
            e.preventDefault();
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            const status = document.getElementById('status').value;
            
            if (!phoneNumber || phoneNumber.length !== 8) {
                alert('Por favor, ingrese un número de teléfono válido de 8 dígitos');
                return;
            }

            try {
                // Guardar en la base de datos TIGO
                await saveRechargeToDatabase(phoneNumber, status);
                
                // Limpiar el formulario
                document.getElementById('phoneNumber').value = '';
                
                // Copiar el número al portapapeles y llamar
                navigator.clipboard.writeText(phoneNumber).then(() => {
                    window.location.href = `tel:*66%23`;
                }).catch(err => {
                    console.error('Error al copiar: ', err);
                    window.location.href = `tel:*66%23`;
                });
                
            } catch (error) {
                console.error('Error al guardar la recarga:', error);
                alert('Error al procesar la recarga. Intente nuevamente.');
            }
        }

        async function saveRechargeToDatabase(phoneNumber, status) {
            const now = new Date();
            
            const timestamp = now.toLocaleString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            const created_at = now.toISOString();

            const rechargeData = {
                user_id: currentUser.id,
                user_name: currentUser.nombre,
                phone_number: phoneNumber,
                estado: status,
                timestamp: timestamp,
                created_at: created_at
            };

            const response = await fetch(`${SUPABASE_URL}/rest/v1/tigo_recharge_history`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(rechargeData)
            });

            if (!response.ok) {
                throw new Error('Error al guardar en la base de datos');
            }

            loadRechargeHistory();
            
            return { success: true };
        }

        async function loadRechargeHistory() {
            const loadingDiv = document.getElementById('loadingHistory');
            const historyList = document.getElementById('historyList');
            const emptyHistory = document.getElementById('emptyHistory');
            const dateFilterInfo = document.getElementById('dateFilterInfo');
            
            loadingDiv.classList.remove('d-none');
            historyList.innerHTML = '';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/tigo_recharge_history?user_id=eq.${currentUser.id}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Error al cargar el historial');
                }

                let rechargeHistory = await response.json();
                
                const now = new Date();
                const todayString = now.toLocaleDateString('es-ES', {
                    day: '2-digit',
                    month: '2-digit', 
                    year: 'numeric'
                });
                
                currentDateFilter = todayString;
                rechargeHistory = filterHistoryByDate(rechargeHistory, todayString);
                
                const dateDisplay = now.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.getElementById('currentDateDisplay').textContent = dateDisplay;
                dateFilterInfo.classList.remove('d-none');
                
                rechargeHistory.sort((a, b) => {
                    const dateA = new Date(a.created_at);
                    const dateB = new Date(b.created_at);
                    return dateB.getTime() - dateA.getTime();
                });
                
                currentUserHistory = rechargeHistory;
                
                if (rechargeHistory.length > 0) {
                    emptyHistory.classList.add('d-none');
                } else {
                    emptyHistory.classList.remove('d-none');
                }
                
                displayHistory(rechargeHistory);
                
            } catch (error) {
                console.error('Error al cargar el historial:', error);
                displayHistory([]);
            } finally {
                loadingDiv.classList.add('d-none');
            }
        }

        function filterHistoryByDate(history, dateString) {
            return history.filter(item => {
                try {
                    const timestampText = item.timestamp;
                    const fechaPart = timestampText.split(',')[0].trim();
                    return fechaPart === dateString;
                } catch (error) {
                    console.error('Error al procesar fecha del item:', item, error);
                    return false;
                }
            });
        }

        function displayHistory(history) {
            const historyList = document.getElementById('historyList');
            const echoCountElement = document.getElementById('echoCount');
            const errorCountElement = document.getElementById('errorCount');
            const novalidoCountElement = document.getElementById('novalidoCount');
            const recargasValidasCount = document.getElementById('recargasValidasCount');
            
            if (history.length === 0) {
                historyList.innerHTML = '';
                echoCountElement.textContent = '0';
                errorCountElement.textContent = '0';
                novalidoCountElement.textContent = '0';
                recargasValidasCount.textContent = '0';
                return;
            }

            const echoHistory = history.filter(item => item.estado === 'ECHO');
            const errorHistory = history.filter(item => item.estado === 'ERROR');
            const novalidoHistory = history.filter(item => item.estado === 'NO VALIDO');
            
            // CONTAR SOLO RECARGAS VÁLIDAS (ECHO + ERROR)
            const totalValidas = echoHistory.length + errorHistory.length;
            
            echoCountElement.textContent = echoHistory.length;
            errorCountElement.textContent = errorHistory.length;
            novalidoCountElement.textContent = novalidoHistory.length;
            recargasValidasCount.textContent = totalValidas;
            
            let numeroActual = history.length;
            
            historyList.innerHTML = history.map((item, index) => {
                const isEcho = item.estado === 'ECHO';
                const isError = item.estado === 'ERROR';
                const isNovalido = item.estado === 'NO VALIDO';
                
                let itemClass = '';
                let phoneClass = '';
                let indicatorClass = '';
                let indicatorText = '';
                let statusClass = '';
                let bubbleClass = '';
                let bubbleBadgeClass = '';
                let iconClass = '';
                
                if (isEcho) {
                    itemClass = 'history-item-echo';
                    phoneClass = 'phone-echo';
                    indicatorClass = 'echo-indicator';
                    indicatorText = 'ECHO';
                    statusClass = 'status-echo';
                    bubbleClass = 'status-bubble-echo';
                    bubbleBadgeClass = 'status-bubble-badge-echo';
                    iconClass = 'bi bi-check-circle';
                } else if (isError) {
                    itemClass = 'history-item-error';
                    phoneClass = 'phone-error';
                    indicatorClass = 'error-indicator';
                    indicatorText = 'ERROR';
                    statusClass = 'status-error';
                    bubbleClass = 'status-bubble-error';
                    bubbleBadgeClass = 'status-bubble-badge-error';
                    iconClass = 'bi bi-exclamation-octagon';
                } else if (isNovalido) {
                    itemClass = 'history-item-novalido';
                    phoneClass = 'phone-novalido';
                    indicatorClass = 'novalido-indicator';
                    indicatorText = 'NO VÁLIDO';
                    statusClass = 'status-novalido';
                    bubbleClass = 'status-bubble-novalido';
                    bubbleBadgeClass = 'status-bubble-badge-novalido';
                    iconClass = 'bi bi-slash-circle';
                }
                
                const numero = numeroActual - index;
                const now = new Date();
                const itemDate = new Date(item.created_at);
                const diffMs = now - itemDate;
                const diffMins = Math.floor(diffMs / 60000);
                const isRecent = diffMins < 60;
                
                const estadoBurbuja = item.estado === 'NO VALIDO' ? 'NV' : item.estado.charAt(0);
                
                return `
                <div class="${itemClass} p-3 border-bottom" data-status="${item.estado.toLowerCase().replace(' ', '')}" data-date="${item.created_at}">
                    ${isRecent ? '<div class="new-item-indicator"></div>' : ''}
                    <div class="history-item-header d-flex justify-content-between align-items-start">
                        <div class="d-flex align-items-center">
                            <div class="numero-badge">${numero}</div>
                            <div>
                                <div class="phone-info mb-1">
                                    <div class="phone-display ${phoneClass}">${item.phone_number}</div>
                                    <span class="${indicatorClass}">
                                        <i class="bi ${iconClass.replace('bi ', '')} me-1"></i>${indicatorText}
                                    </span>
                                </div>
                                <div class="d-flex flex-wrap gap-2">
                                    <span class="user-info">
                                        <i class="bi bi-person-circle"></i> ${item.user_name}
                                    </span>
                                    <span class="user-info">
                                        <i class="bi bi-calendar"></i> ${item.timestamp}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="status-bubble ${bubbleClass}">
                            <i class="${iconClass}"></i>
                            <div class="status-bubble-badge ${bubbleBadgeClass}">${estadoBurbuja}</div>
                        </div>
                    </div>
                    
                    <div class="d-flex align-items-center justify-content-between mt-3">
                        <div class="d-flex align-items-center">
                            <select class="status-select ${statusClass}" 
                                    data-id="${item.id}" onchange="updateStatus(this)">
                                <option value="ECHO" ${isEcho ? 'selected' : ''}>Echo</option>
                                <option value="ERROR" ${isError ? 'selected' : ''}>Error</option>
                                <option value="NO VALIDO" ${isNovalido ? 'selected' : ''}>No Valido</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="history-item-actions">
                        <button class="history-action-btn" onclick="copyNumber('${item.phone_number}', this)">
                            <i class="bi bi-phone"></i> Copiar Número
                        </button>
                        <button class="history-action-btn" onclick="callWithCodeAndCopy('${item.phone_number}')">
                            <i class="bi bi-telephone"></i> Llamar
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        async function updateStatus(selectElement) {
            const id = selectElement.getAttribute('data-id');
            const newStatus = selectElement.value;
            
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/tigo_recharge_history?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ 
                            estado: newStatus
                        })
                    }
                );

                if (!response.ok) {
                    throw new Error('Error al actualizar el estado');
                }

                loadRechargeHistory();
                
            } catch (error) {
                console.error('Error al actualizar el estado:', error);
                alert('Error al actualizar el estado. Intente nuevamente.');
            }
        }

        function copyNumber(number, button) {
            navigator.clipboard.writeText(number).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i> ¡Copiado!';
                button.style.background = 'var(--success-color)';
                button.style.color = 'white';
                button.style.borderColor = 'var(--success-color)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                    button.style.color = '';
                    button.style.borderColor = '';
                }, 2000);
            }).catch(err => {
                console.error('Error al copiar: ', err);
            });
        }

        function callWithCodeAndCopy(number) {
            navigator.clipboard.writeText(number).then(() => {
                window.location.href = `tel:*66%23`;
            }).catch(err => {
                console.error('Error al copiar: ', err);
                window.location.href = `tel:*66%23`;
            });
        }

        function showClearHistoryModal() {
            if (currentUserHistory.length === 0) {
                alert('No hay historial para descargar y eliminar');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('clearHistoryModal'));
            modal.show();
        }

        async function confirmClearHistory() {
            try {
                await generateHistoryPDF();
                await deleteUserHistory();
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('clearHistoryModal'));
                modal.hide();
                
                alert('Historial descargado y eliminado exitosamente');
                
            } catch (error) {
                console.error('Error al descargar y eliminar el historial:', error);
                alert('Error al procesar la solicitud. Intente nuevamente.');
            }
        }

        async function deleteUserHistory() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/tigo_recharge_history?user_id=eq.${currentUser.id}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Prefer': 'return=minimal'
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Error al eliminar el historial de la base de datos');
                }

                loadRechargeHistory();
                
            } catch (error) {
                console.error('Error al eliminar el historial:', error);
                throw error;
            }
        }

        function generateHistoryPDF() {
            return new Promise((resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    doc.setFontSize(20);
                    doc.setTextColor(0, 94, 184);
                    doc.text('Historial de Recargas - TIGO', 20, 20);
                    
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Usuario: ${currentUser.nombre}`, 20, 35);
                    doc.text(`Fecha de generación: ${new Date().toLocaleString('es-ES')}`, 20, 42);
                    
                    const tableColumn = ["#", "Teléfono", "Estado", "Fecha"];
                    const tableRows = [];
                    
                    currentUserHistory.forEach((item, index) => {
                        const rowData = [
                            index + 1,
                            item.phone_number,
                            item.estado,
                            item.timestamp
                        ];
                        tableRows.push(rowData);
                    });
                    
                    doc.autoTable({
                        head: [tableColumn],
                        body: tableRows,
                        startY: 50,
                        theme: 'grid',
                        styles: {
                            fontSize: 10,
                            cellPadding: 3
                        },
                        headStyles: {
                            fillColor: [0, 94, 184],
                            textColor: 255
                        },
                        alternateRowStyles: {
                            fillColor: [240, 240, 240]
                        }
                    });
                    
                    const fileName = `Historial_Recargas_TIGO_${currentUser.nombre}_${new Date().toISOString().slice(0,10)}.pdf`;
                    doc.save(fileName);
                    
                    resolve();
                } catch (error) {
                    console.error('Error al generar PDF:', error);
                    reject(error);
                }
            });
        }
    </script>
</body>
</html>
